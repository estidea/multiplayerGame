<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Аркада на canvas</title>
	<link rel="stylesheet" href="client/css/style.css">
</head>
<body>
	<div id="auth-container">
		<div class="input-group">
			<label class="form-label" for="auth-username">Username</label>
			<input class="form-input" id="auth-username" type="text">
		</div>
		<div class="input-group">
			<label class="form-label" for="">Password</label>
			<input class="form-input" id="auth-password" type="password">
		</div>
		<div class="input-group">
			<button class="form-btn" id="auth-signIn">Sign In</button>
		</div>
		<p>Have not an account? Use filled username and password <a href="#" class="auth-link" id="auth-signUp">to Sign Up</a></p>
		<p>Or you can <a href="#" class="auth-link" id="auth-guest">Play as guest!</a></p>
	</div>

	<div id="game-container" style="display:none">
		<canvas id="canvas-main"></canvas>
		<div id="chat-container">
			<div id="chat-text">
			</div>
			<form id="chat-form">
				<input id="chat-input" type="text" placeholder="Введите ваше сообщение">
			</form>
		</div>
	</div>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
	<script>
		var socket = io();
		var gameContainer = document.getElementById('game-container');
		
		/* ============= AUTH SCREEN ================= */
		// =========================================== //
		var authContainer = document.getElementById('auth-container');
		var authUsername = document.getElementById('auth-username');
		var authPassword = document.getElementById('auth-password');
		var authSignIn = document.getElementById('auth-signIn');
		var authSignUp = document.getElementById('auth-signUp');
		var authGuest = document.getElementById('auth-guest');

		authSignIn.onclick = function() {
			socket.emit('signIn',{username:authUsername.value,password:authPassword.value});
		}

		socket.on('signInResponse', function(data) {
			if(data.success){
				authContainer.style.display = "none";
				gameContainer.style.display = "block";
			} else {
				alert("Sign in is unsuccessfull \n" + data.errorMsg);
			}
		});

		authSignUp.onclick = function() {
			socket.emit('signUp',{username:authUsername.value,password:authPassword.value});
		}

		socket.on('signUpResponse', function(data) {
			if(data.success){
				alert("Sign up is successfull. Use your username and password to login");
			} else {
				alert("Sign up is unsuccessfull \n" + data.errorMsg);
			}
		});

		authGuest.onclick = function() {
			socket.emit('signGuest');
		}

		socket.on('signGuestResponse', function(data) {
			if(data.success){
				authContainer.style.display = "none";
				gameContainer.style.display = "block";
			} else {
				alert("It doesn't work now \n" + data.errorMsg);
			}
		});


		/* ============= GAME SCREEN ================= */
		// =========================================== //
		var canvas = document.getElementById("canvas-main");

		canvas.width = window.innerWidth;
		canvas.height = window.innerHeight;
		var WIDTH = canvas.width;
		var HEIGHT = canvas.height;

		var ctx = canvas.getContext('2d');
		
		ctx.font = "40px Arial";

		// ============ init ===============
		var Player = function(initPack) {
			var self = {};
			self.id = initPack.id;
			self.name = initPack.name;
			self.x = initPack.x;
			self.y = initPack.y;
			Player.list[self.id] = self;
			return self;
		}

		Player.list = {};

		var Bullet = function(initPack) {
			var self = {};
			self.id = initPack.id;
			self.x = initPack.x;
			self.y = initPack.y;
			Bullet.list[self.id] = self;
			return self;
		}

		Bullet.list = {};
		
		socket.on('init',function(data){
			for(var i=0;i<data.player.length;i++){
				new Player(data.player[i]);
			}
			for(var i=0;i<data.bullet.length;i++){
				new Bullet(data.bullet[i]);
			}
		});

		// ============ update ===============
		socket.on('update',function(data){
			for(var i=0;i<data.player.length;i++){
				var pack = data.player[i];
				var updatedPlayer = Player.list[pack.id];
				if(updatedPlayer) {
					if(pack.x !== undefined)
						updatedPlayer.x = pack.x;
					if(pack.y !== undefined)
						updatedPlayer.y = pack.y;
				}
			}
			for(var i=0;i<data.bullet.length;i++){
				var pack = data.bullet[i];
				var updatedBullet = Bullet.list[pack.id];
				if(updatedBullet) {
					if(pack.x !== undefined)
						updatedBullet.x = pack.x;
					if(pack.y !== undefined)
						updatedBullet.y = pack.y;
				}
			}
		});

		// ============ remove ===============
		socket.on('remove',function(data){
			for(var i=0;i<data.player.length;i++){
				delete Player.list[data.player[i]];
			}
			for(var i=0;i<data.bullet.length;i++){
				delete Bullet.list[data.bullet[i]];
			}
		});

		setInterval(function(){
			ctx.clearRect(0,0,WIDTH,HEIGHT);
			for (var i in Player.list){
				ctx.fillStyle = "#29e929";
				ctx.fillText(Player.list[i].name,Player.list[i].x,Player.list[i].y);
			}
			for (var i in Bullet.list){
				ctx.fillStyle = "red";
				ctx.fillRect(Bullet.list[i].x-5,Bullet.list[i].y-5,10,10);
			}
		},20);

		// ============ events ===============
		document.onkeydown = function(e) {
			if(e.keyCode === 68) //d
				socket.emit('keyPress',{inputId:'right', state:true});
			if(e.keyCode === 83) //s
				socket.emit('keyPress',{inputId:'bottom', state:true});
			if(e.keyCode === 65) //a
				socket.emit('keyPress',{inputId:'left', state:true});
			if(e.keyCode === 87) //w
				socket.emit('keyPress',{inputId:'top', state:true});
		}

		document.onkeyup = function(e) {
			if(e.keyCode === 68) //d
				socket.emit('keyPress',{inputId:'right', state:false});
			if(e.keyCode === 83) //s
				socket.emit('keyPress',{inputId:'bottom', state:false});
			if(e.keyCode === 65) //a
				socket.emit('keyPress',{inputId:'left', state:false});
			if(e.keyCode === 87) //w
				socket.emit('keyPress',{inputId:'top', state:false});
		}

		document.onmousedown = function(e) {
			socket.emit('keyPress',{inputId:'attack',state:true});
		}

		document.onmouseup = function(e) {
			socket.emit('keyPress',{inputId:'attack',state:false});
		}

		document.onmousemove = function(e) {
			var x = -WIDTH/2 + e.clientX - 8;
			var y = -HEIGHT/2 + e.clientY - 8;
			var angle = Math.atan2(y,x) / Math.PI *180;
			socket.emit('keyPress',{inputId:'mouseAngle',state:angle});
		}

		// ========== chat ========== //
		var chatText = document.getElementById('chat-text');
		var chatInput = document.getElementById('chat-input');
		var chatForm = document.getElementById('chat-form');

		canvas.onselectstart = function() {
		    return false;
		};

		chatForm.onsubmit = function(e) {
			e.preventDefault();
			if(chatInput.value[0] === '/')
				socket.emit('evalServer',chatInput.value.slice(1));
			else
				socket.emit('chatMsgToServ',chatInput.value);
			chatInput.value = "";
		}

		socket.on('chatMsgToClient',function(data){
			chatText.innerHTML += data;
			chatText.scrollTo(0,chatText.scrollHeight);
		});

		socket.on('evalAnswer',function(data){
			console.log(data);
		});

		
	</script>
</body>
</html>